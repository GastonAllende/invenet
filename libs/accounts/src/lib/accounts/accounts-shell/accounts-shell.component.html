<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="account-shell">
  @if (isListMode()) {
    <lib-account-list
      [accounts]="accounts()"
      [activeAccountId]="activeAccountId()"
      [includeArchived]="includeArchived()"
      [isLoading]="isLoading()"
      (includeArchivedChange)="onIncludeArchivedChange($event)"
      (create)="onCreateAccount()"
      (viewClicked)="onViewAccount($event)"
      (setActiveClicked)="onSetActiveAccount($event)"
      (archiveClicked)="onArchiveAccount($event)"
      (unarchiveClicked)="onUnarchiveAccount($event)"
    ></lib-account-list>
  }

  @if (isCreateMode()) {
    <section class="account-header">
      <h1 class="account-title">Create Account</h1>
      <p class="account-subtitle">
        Define your risk rules before logging trades.
      </p>
    </section>

    <section class="panel">
      <div class="panel-block">
        <h2 class="panel-title">Account Details</h2>
        <p class="panel-subtitle">
          Configure account type, broker, and base currency.
        </p>
      </div>

      <div class="panel-block">
        <h2 class="panel-title">Risk Rules</h2>
        <p class="panel-subtitle">
          Define institutional-grade risk limits before trading.
        </p>
      </div>

      <details class="advanced">
        <summary>Advanced</summary>
        <p>Optional constraints and notes can be configured here.</p>
      </details>

      <lib-invenet-account-form
        [mode]="'create'"
        [isLoading]="isLoading()"
        [showTitle]="false"
        [showCancel]="!isOnboarding()"
        (formSubmit)="onSaveAccount($event)"
        (formCancel)="onCancelForm()"
      ></lib-invenet-account-form>
    </section>
  }

  @if (isDetailMode() && selectedAccount(); as account) {
    <section class="account-header account-header-row">
      <div>
        <h1 class="account-title">{{ account.name }}</h1>
        <p class="account-subtitle">
          Base currency: {{ account.baseCurrency }}
          @if (activeAccount(); as active) {
            <span class="active-indicator">Active: {{ active.name }}</span>
          }
        </p>
      </div>

      @if (!editMode()) {
        <div class="header-actions">
          <p-button
            label="Edit"
            icon="pi pi-pencil"
            (onClick)="onEnterEditMode()"
          ></p-button>
          @if (activeAccountId() !== account.id) {
            <p-button
              label="Set Active"
              icon="pi pi-star"
              severity="secondary"
              [outlined]="true"
              (onClick)="onSetActiveAccount(account.id)"
            ></p-button>
          }
          @if (account.isActive) {
            <p-button
              label="Archive"
              icon="pi pi-archive"
              severity="secondary"
              [outlined]="true"
              (onClick)="onArchiveAccount(account.id)"
            ></p-button>
          } @else {
            <p-button
              label="Unarchive"
              icon="pi pi-replay"
              severity="secondary"
              [outlined]="true"
              (onClick)="onUnarchiveAccount(account.id)"
            ></p-button>
          }
          <p-button
            label="Create Account"
            icon="pi pi-plus"
            severity="contrast"
            [outlined]="true"
            (onClick)="onCreateAccount()"
          ></p-button>
        </div>
      }
    </section>

    @if (!editMode()) {
      <section class="overview-grid">
        <article class="panel">
          <h2 class="panel-title">Risk Summary</h2>
          <div class="kv-grid">
            <div class="kv-item">
              <span class="kv-label">Risk per trade</span>
              <span class="kv-value">{{ account.riskSettings.riskPerTradePct }}%</span>
            </div>
            <div class="kv-item">
              <span class="kv-label">Max daily loss</span>
              <span class="kv-value">{{ account.riskSettings.maxDailyLossPct }}%</span>
            </div>
            <div class="kv-item">
              <span class="kv-label">Max weekly loss</span>
              <span class="kv-value">{{ account.riskSettings.maxWeeklyLossPct }}%</span>
            </div>
            <div class="kv-item">
              <span class="kv-label">Portfolio exposure cap</span>
              <span class="kv-value">Not configured</span>
            </div>
          </div>
        </article>

        <article class="panel">
          <h2 class="panel-title">Account Details</h2>
          <div class="kv-grid">
            <div class="kv-item">
              <span class="kv-label">Broker</span>
              <span class="kv-value">{{ account.broker || 'Not specified' }}</span>
            </div>
            <div class="kv-item">
              <span class="kv-label">Account type</span>
              <span class="kv-value">{{ account.accountType }}</span>
            </div>
            <div class="kv-item kv-item-full">
              <span class="kv-label">Notes</span>
              <span class="kv-value">{{ account.notes || 'No notes provided' }}</span>
            </div>
          </div>
        </article>
      </section>
    } @else {
      <section class="panel">
        <lib-invenet-account-form
          [account]="account"
          [mode]="'update'"
          [isLoading]="isLoading()"
          [showTitle]="false"
          [showCancel]="true"
          (formSubmit)="onSaveAccount($event)"
          (formCancel)="onCancelForm()"
        ></lib-invenet-account-form>
      </section>
    }
  }
</div>
