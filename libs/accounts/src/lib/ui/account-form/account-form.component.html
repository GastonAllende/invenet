<div class="account-form-container">
  <form [formGroup]="accountForm" (ngSubmit)="onSubmit()" class="account-form">
    @if (showTitle()) {
      <h2 class="form-title">
        {{ isEditMode ? 'Edit Account' : 'Create Account' }}
      </h2>
    }

    <!-- Basic Account Information -->
    <div class="form-section">
      <h3>Account Details</h3>

      <div class="form-field">
        <label for="name">Account Name *</label>
        <input
          pInputText
          id="name"
          formControlName="name"
          placeholder="My Trading Account"
          class="input-full-width"
        />
        @if (name?.invalid && name?.touched) {
          <small class="error-message">
            @if (name?.errors?.['required']) {
              Account name is required
            }
            @if (name?.errors?.['maxlength']) {
              Max 200 characters allowed
            }
          </small>
        }
      </div>

      <div class="form-field">
        <label for="broker">Broker</label>
        <p-select
          [options]="brokers"
          formControlName="broker"
          optionLabel="label"
          optionValue="value"
          placeholder="Select broker (optional)"
          styleClass="dropdown-full-width"
          [showClear]="true"
        ></p-select>
        @if (broker?.invalid && broker?.touched) {
          <small class="error-message">
            @if (broker?.errors?.['maxlength']) {
              Max 100 characters allowed
            }
          </small>
        }
      </div>

      <div class="form-row">
        <div class="form-field">
          <label for="accountType">Account Type *</label>
          <p-select
            [options]="accountTypes"
            formControlName="accountType"
            optionLabel="label"
            optionValue="value"
            placeholder="Select type"
            styleClass="dropdown-full-width"
          ></p-select>
          @if (accountType?.invalid && accountType?.touched) {
            <small class="error-message">Account type is required</small>
          }
        </div>

        <div class="form-field">
          <label for="baseCurrency">Base Currency *</label>
          <p-select
            [options]="currencies"
            formControlName="baseCurrency"
            optionLabel="label"
            optionValue="value"
            placeholder="Select currency"
            styleClass="dropdown-full-width"
          ></p-select>
          @if (baseCurrency?.invalid && baseCurrency?.touched) {
            <small class="error-message">Base currency is required</small>
          }
        </div>
      </div>

      <div class="form-row">
        <div class="form-field">
          <label for="startDate">Start Date *</label>
          @if (isEditMode) {
            <p-datepicker
              formControlName="startDate"
              [showIcon]="false"
              dateFormat="yy-mm-dd"
              styleClass="calendar-full-width readonly-field"
              [disabled]="true"
            ></p-datepicker>
          } @else {
            <p-datepicker
              formControlName="startDate"
              [showIcon]="true"
              dateFormat="yy-mm-dd"
              styleClass="calendar-full-width"
            ></p-datepicker>
          }
          @if (startDate?.invalid && startDate?.touched) {
            <small class="error-message">Start date is required</small>
          }
        </div>

        <div class="form-field">
          <label for="startingBalance">Starting Balance *</label>
          @if (isEditMode) {
            <p-inputNumber
              formControlName="startingBalance"
              mode="currency"
              [currency]="baseCurrency?.value || 'USD'"
              locale="en-US"
              [minFractionDigits]="2"
              [min]="0.01"
              styleClass="input-number-full-width readonly-field"
              [disabled]="true"
            ></p-inputNumber>
          } @else {
            <p-inputNumber
              formControlName="startingBalance"
              mode="currency"
              [currency]="baseCurrency?.value || 'USD'"
              locale="en-US"
              [minFractionDigits]="2"
              [min]="0.01"
              styleClass="input-number-full-width"
            ></p-inputNumber>
          }
          @if (startingBalance?.invalid && startingBalance?.touched) {
            <small class="error-message">
              @if (startingBalance?.errors?.['required']) {
                Starting balance is required
              }
              @if (startingBalance?.errors?.['min']) {
                Minimum balance is 0.01
              }
            </small>
          }
        </div>
      </div>

      <div class="form-field checkbox-field">
        <p-checkbox
          formControlName="isActive"
          [binary]="true"
          inputId="isActive"
          label="Account Active"
        ></p-checkbox>
      </div>
    </div>

    <!-- Risk Settings -->
    <div class="form-section" formGroupName="riskSettings">
      <h3>Risk Management Settings</h3>

      <div class="form-row">
        <div class="form-field">
          <label for="riskPerTradePct">Risk Per Trade (%)</label>
          <p-inputNumber
            formControlName="riskPerTradePct"
            [min]="0"
            [max]="100"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            suffix="%"
            styleClass="input-number-full-width"
          ></p-inputNumber>
          @if (riskPerTradePct?.invalid && riskPerTradePct?.touched) {
            <small class="error-message">Must be between 0 and 100</small>
          }
        </div>

        <div class="form-field">
          <label for="maxDailyLossPct">Max Daily Loss (%)</label>
          <p-inputNumber
            formControlName="maxDailyLossPct"
            [min]="0"
            [max]="100"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            suffix="%"
            styleClass="input-number-full-width"
          ></p-inputNumber>
          @if (maxDailyLossPct?.invalid && maxDailyLossPct?.touched) {
            <small class="error-message">Must be between 0 and 100</small>
          }
        </div>
      </div>

      <div class="form-field checkbox-field">
        <p-checkbox
          formControlName="enforceLimits"
          [binary]="true"
          inputId="enforceLimits"
          label="Enforce Risk Limits"
        ></p-checkbox>
      </div>
    </div>

    <details class="form-section">
      <summary><h3>Advanced</h3></summary>

      <div class="form-row" formGroupName="riskSettings">
        <div class="form-field">
          <label for="maxWeeklyLossPct">Max Weekly Loss (%)</label>
          <p-inputNumber
            formControlName="maxWeeklyLossPct"
            [min]="0"
            [max]="100"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            suffix="%"
            styleClass="input-number-full-width"
          ></p-inputNumber>
          @if (maxWeeklyLossPct?.invalid && maxWeeklyLossPct?.touched) {
            <small class="error-message">Must be between 0 and 100</small>
          }
        </div>
      </div>

      <div class="form-field">
        <label for="timezone">Timezone</label>
        <p-select
          [options]="timezones"
          formControlName="timezone"
          optionLabel="label"
          optionValue="value"
          placeholder="Select timezone"
          styleClass="dropdown-full-width"
          [showClear]="true"
        ></p-select>
      </div>

      <div class="form-field">
        <label for="notes">Notes</label>
        <textarea
          pTextarea
          id="notes"
          formControlName="notes"
          placeholder="Optional notes about this account"
          rows="3"
          class="input-full-width"
        ></textarea>
      </div>
    </details>

    <!-- Form Actions -->
    <div class="form-actions">
      @if (showCancel()) {
        <p-button
          label="Cancel"
          severity="secondary"
          (onClick)="onCancel()"
          [outlined]="true"
          type="button"
          [disabled]="isLoading()"
        ></p-button>
      }
      <p-button
        [label]="resolvedSubmitLabel"
        type="submit"
        [disabled]="accountForm.invalid || isLoading()"
        [loading]="isLoading()"
      ></p-button>
    </div>
  </form>
</div>
